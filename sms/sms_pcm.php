<?php
ini_set('display_errors', 1);
ini_set('memory_limit', '-1');
set_time_limit(0);

header("Access-Control-Allow-Origin: *");
header("Content-Type: text/plain");


function _getByTag($xml, $tag){
    $pattern = "#<\s*?$tag\b[^>]*>(.*?)</$tag\b[^>]*>#s";
    preg_match($pattern, $xml, $matches);
    return $matches[1];
}

function enviarSMS($celular, $mensaje, $once = 1){
	$max_onces = 3;
	if(extension_loaded('curl')){ 

	    $usuario = "mininter";
	    $clave = "1Xv3dt6Us1R8";

	    //Preparamos las variables que queremos enviar
	    $url = 'http://ws.pide.gob.pe/SMS_ServiceSoap ';
	    $data = "<soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:app=\"http://appbinomio.com/\">
				   <soapenv:Header/>
				   <soapenv:Body>
				      <app:envioSMS>
				         <app:usuario>".$usuario."</app:usuario>
				         <app:keyws>".$clave."</app:keyws>
				         <app:celular>".$celular."</app:celular>
				         <app:mensaje>".$mensaje."</app:mensaje>
				      </app:envioSMS>
				   </soapenv:Body>
				</soapenv:Envelope>";

	    //Preparamos el string para hacer POST (formato querystring)
	    $ch = @curl_init();
		@curl_setopt($ch, CURLOPT_URL, $url);
		@curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type: text/xml','Content-Length: ' . strlen($data)));
		@curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'PUT');
		@curl_setopt($ch, CURLOPT_POSTFIELDS,$data);
		@curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

	    //ejecutamos POST
	    $result  = _getByTag(@curl_exec($ch),'envioSMSResult');

	    //cerramos la conexion
	    @curl_close($ch);

	    if($result=='OK'){
	    	return TRUE;
	    }else{
	    	sleep(1);
	    	if($once <= $max_onces){
	    		return enviarSMS($celular, $mensaje, $once + 1);
	    	}
	    }

	    return FALSE;
	}else{
		return FALSE;      
	}
}




$campaign_list = array(
	'NOMBRE;CELULAR',	
'982520733;982520733',
'952368540;952368540',
'921950467;921950467',
'992784059;992784059',
'940408509;940408509',
'997357226;997357226',
'997553319;997553319',
'974987561;974987561',
'957275791;957275791',
'987534038;987534038',
'949178546;949178546',
'946893100;946893100',
'997523590;997523590',
'989072847;989072847',
'980121726;980121726',
'986772189;986772189',
'976323513;976323513',
'992772813;992772813',
'941042244;941042244',
'972762991;972762991',
'941763317;941763317',
'997546327;997546327',
'997872441;997872441',
'951328262;951328262',
'962241195;962241195',
'989163291;989163291',
'962702050;962702050',
'966560102;966560102',
'954361014;954361014',
'940930207;940930207',
'993540711;993540711',
'963889529;963889529',
'944263408;944263408',
'965370485;965370485',
'997600997;997600997',
'953275276;953275276',
'940150837;940150837',
'989281068;989281068',
'997579804;997579804',
'952337474;952337474',
'974619755;974619755',
'982828302;982828302',
'987294669;987294669',
'954198584;954198584',
'989129992;989129992',
'952501373;952501373',
'997546515;997546515',
'993132544;993132544',
'964178383;964178383',
'969799826;969799826',
'980121051;980121051',
'977179592;977179592',
'982748738;982748738',
'993805126;993805126',
'959177586;959177586',
'997581215;997581215',
'993538071;993538071',
'963347725;963347725',
'983335232;983335232',
'989092499;989092499',
'989186442;989186442',
'970000424;970000424',
'937775366;937775366',
'963738597;963738597',
'937263156;937263156',
'997355020;997355020',
'922171787;922171787',
'989058928;989058928',
'994649810;994649810',
'942711690;942711690',
'986642727;986642727',
'997871897;997871897',
'964359316;964359316',
'964296593;964296593',
'992017113;992017113',
'984725455;984725455',
'982489283;982489283',
'994608903;994608903',
'989193494;989193494',
'969342503;969342503',
'948332221;948332221',
'989130574;989130574',
'959261584;959261584',
'989086687;989086687',
'966355237;966355237',
'925875086;925875086',
'948354354;948354354',
'999550071;999550071',
'986645291;986645291',
'963303818;963303818',
'956787942;956787942',
'963807916;963807916',
'982040825;982040825',
'956763523;956763523',
'944267556;944267556',
'955763232;955763232',
'949340643;949340643',
'940417117;940417117',
'994314380;994314380',
'987377452;987377452',
'957649693;957649693',
'993547675;993547675',
'964341843;964341843',
'993409757;993409757',
'983155629;983155629',
'954162515;954162515',
'959122663;959122663',
'993534144;993534144',
'972789717;972789717',
'947619522;947619522',
'992715526;992715526',
'952376701;952376701',
'943987817;943987817',
'997874229;997874229',
'949757810;949757810',
'997540456;997540456',
'951365911;951365911',
'944112058;944112058',
'956249568;956249568',
'944266901;944266901',
'997877981;997877981',
'977519620;977519620',
'989137793;989137793',
'977165161;977165161',
'989109387;989109387',
'938938027;938938027',
'934805354;934805354',
'953354513;953354513',
'949511596;949511596',
'982957497;982957497',
'959102565;959102565',
'993531069;993531069',
'991707998;991707998',
'956988067;956988067',
'982848863;982848863',
'997176518;997176518',
'987486762;987486762',
'956758979;956758979',
'992819811;992819811',
'989093907;989093907',
'965348122;965348122',
'931489287;931489287',
'954191065;954191065',
'959072639;959072639',
'941553610;941553610',
'933052920;933052920',
'989197217;989197217',
'991111058;991111058',
'997544933;997544933',
'997539085;997539085',
'963774845;963774845',
'997906296;997906296',
'987487688;987487688',
'949123828;949123828',
'997588052;997588052',
'949235715;949235715',
'983258938;983258938',
'989897917;989897917',
'954194336;954194336',
'941185537;941185537',
'962527355;962527355',
'980775933;980775933',
'997558453;997558453',
'993545701;993545701',
'993549147;993549147',
'972929364;972929364',
'957290900;957290900',
'972925409;972925409',
'972924244;972924244',
'941946910;941946910',
'938524340;938524340',
'986642966;986642966',
'989199071;989199071',
'993347996;993347996',
'992124561;992124561',
'986685783;986685783',
'957296538;957296538',
'966778401;966778401',
'993810657;993810657',
'980498653;980498653',
'940589844;940589844',
'963347790;963347790',
'990747115;990747115',
'993760707;993760707',
'990287433;990287433',
'993547651;993547651',
'997586862;997586862',
'959142838;959142838',
'922257723;922257723',
'942093889;942093889',
'954706127;954706127',
'994648433;994648433',
'987121744;987121744',
'991288051;991288051',
'940250374;940250374',
'983770947;983770947',
'940990991;940990991',
'987275352;987275352',
'993544579;993544579',
'989291708;989291708',
'949711149;949711149',
'953722085;953722085',
'994644698;994644698',
'957873129;957873129',
'980121673;980121673',
'993542846;993542846',
'980121738;980121738',
'980121629;980121629',
'997545726;997545726',
'989135765;989135765',
'980121667;980121667',
'989148611;989148611',
'962372471;962372471',
'980121815;980121815',
'980121613;980121613',
'980121775;980121775',
'993455728;993455728',
'992797066;992797066',
'987246190;987246190',
'980121772;980121772',
'980121685;980121685',
'987392864;987392864',
'993546566;993546566',
'980121683;980121683',
'963755737;963755737',
'989146239;989146239',
'989035780;989035780',
'952302098;952302098',
'989108729;989108729',
'980121781;980121781',
'944326408;944326408',
'997584470;997584470',
'979777903;979777903',
'980121740;980121740',
'997553661;997553661',
'987536181;987536181',
'949703108;949703108',
'984727906;984727906',
'980121612;980121612',
'978141112;978141112',
'943136640;943136640',
'986733469;986733469',
'993384557;993384557',
'980121794;980121794',
'986937325;986937325',
'997902718;997902718',
'945390837;945390837',
'993528797;993528797',
'963943067;963943067',
'980121623;980121623',
'987506113;987506113',
'993547253;993547253',
'980121614;980121614',
'980121627;980121627',
'980122562;980122562',
'993540332;993540332',
'989227192;989227192',
'993591638;993591638',
'980121734;980121734',
'997588140;997588140',
'988348652;988348652',
'980121699;980121699',
'989266497;989266497',
'934063267;934063267',
'993540169;993540169',
'989871895;989871895',
'997355792;997355792',
'980121834;980121834',
'956057595;956057595',
'951300104;951300104',
'980121786;980121786',
'964259301;964259301',
'994686175;994686175',
'997540695;997540695',
'997355280;997355280',
'951753247;951753247',
'982160119;982160119',
'988846010;988846010',
'980121622;980121622',
'993543355;993543355',
'965911693;965911693',
'980121625;980121625',
'980121814;980121814',
'980121825;980121825',
'980121705;980121705',
'993590216;993590216',
'965259705;965259705',
'997539057;997539057',
'980122574;980122574',
'980121723;980121723',
'989005501;989005501',
'980121797;980121797',
'940396283;940396283',
'989192925;989192925',
'944521224;944521224',
'986604405;986604405',
'980121729;980121729',
'994649720;994649720',
'963709661;963709661',
'940375292;940375292',
'997357340;997357340',
'980121776;980121776',
'989179372;989179372',
'955764170;955764170',
'975531904;975531904',
'987771587;987771587',
'989195558;989195558',
'980121842;980121842',
'997559784;997559784',
'993591997;993591997',
'997897703;997897703',
'998567015;998567015',
'991893061;991893061',
'997900334;997900334',
'949279785;949279785',
'944263579;944263579',
'980121803;980121803',
'980122473;980122473',
'940351338;940351338',
'959139230;959139230',
'993107130;993107130',
'961803411;961803411',
'957649845;957649845',
'993591856;993591856',
'992775084;992775084',
'987361822;987361822',
'987338280;987338280',
'968750444;968750444',
'958815043;958815043',
'974126882;974126882',
'957284330;957284330',
'993006328;993006328',
'994799034;994799034',
'961783164;961783164',
'977153975;977153975',
'982829963;982829963',
'980098299;980098299',
'987489132;987489132',
'941993089;941993089',
'972819552;972819552',
'970617463;970617463',
'988477027;988477027',
'963315829;963315829',
'989326434;989326434',
'980122522;980122522',
'984476099;984476099',
'935189156;935189156',
'993546715;993546715',
'986404150;986404150',
'992628562;992628562',
'970851228;970851228',
'950172896;950172896',
'966963275;966963275',
'986655862;986655862',
'993398079;993398079',
'922757442;922757442',
'957872969;957872969',
'950165680;950165680',
'942914812;942914812',
'983321085;983321085',
'993593094;993593094',
'989198901;989198901',
'969835005;969835005',
'954770935;954770935',
'989280647;989280647',
'965704509;965704509',
'983279061;983279061',
'991327030;991327030',
'942927277;942927277',
'944584425;944584425',
'993558260;993558260',
'972905835;972905835',
'989198087;989198087',
'949994687;949994687',
'997829957;997829957',
'997540164;997540164',
'957649857;957649857',
'991194404;991194404',
'989091578;989091578',
'955762968;955762968',
'997690261;997690261',
'977238945;977238945',

'975119277;975119277',
'987139031;987139031',
'933494786;933494786',
'923236608;923236608'
);


$col_celular = 1;
$log = $campaign_list[0].";EXEC\n";
for ($i=1; $i < count($campaign_list); $i++) { 
	$data = explode(';', $campaign_list[$i]);
	$log.= $campaign_list[$i].';';

	$mensaje = "Saludamos a la familia policial por su XXIX Aniversario. Seguiremos trabajando para promover una cultura de igualdad. Defensoria del Policia";
	//echo $data[$col_celular]."\n";
	$envio = enviarSMS($data[$col_celular],$mensaje);
	

	if($envio){
		$log.="OK - ".$mensaje;
	}else{
		$log.="ERROR";
	}
	$log.="\n";
}

file_put_contents('logs/campaign_log_'.date('Ymdhis').'.csv', $log);
echo $log;
echo "\n";
echo "\n";
echo "\n";